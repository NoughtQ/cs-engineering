---
title: HTTP
slug: HTTP
sidebar_position: 0
---


# HTTP

Author：陶泓宇

## <b>web</b>

http的全称是超文本传送协议(hypertext transfer protocol)，http是一个应用层协议，它使用TCP进行可靠数据传输，http协议在过去的几十年间，经历了很多变化，接下来我们将介绍http协议经历过的或正在经历的几个版本

### <b>http1.1</b>

http1.1版本的特性和缺点如下

特点

1. 使用TCP长连接改善了http/1.0短连接造成的性能开销
2. 支持pipeline网络传输，也就是当第一个请求发出去后，不必等其回来，就可以发第二个请求出去

缺点

1. 请求头信息过大且冗余
2. 由于服务器是按照请求的顺序响应的，如果服务器响应慢，就会导致客户端已一直请求不到数据，也就是队头阻塞
3. 请求只能从客户端开始

![](/assets/Ya76bMZ99oydL1xTZJYcaUG8nmf.png)

#### <b>队头阻塞</b>

HTTP/1 中的 HTTP Head of Line 阻塞是指浏览器/客户端必须等待请求完成才能触发另一个请求的问题。<b>HTTP 请求头会阻塞单个 TCP 连接</b>上的后续请求。

队头阻塞的示例图如下

![](/assets/GrybbnEV9o6nR7xNwxfcEgu6nmc.png)

为了解决这个问题，当时的开发者采用了并行打开多个TCP连接来加速网页加载，但是这也带来了如下几个问题

1. HTTP1中同时可以打开的最大连接数量是有限的
2. 打开TCP连接本身需要的时间会增加延迟
3. 多个TCP连接受制于无线网络带宽限制

#### <b>头部信息冗余问题</b>

![](/assets/V2XPbtgcKoe6IWxOD2Ac4nJ5nhb.png)

上图是HTTP/1.1下一个请求header的示例，HTTP/1.*中的每个请求都包含许多http标头，这些标头的数量和大小有时可能会非常大，并且由于http/1.1在后续的请求中也会通过网络发送所有的标头，这不仅会增加网络带宽的负载，还会增加延迟

#### <b>部分解决方案</b>

为了解决这些问题，当时的开发者使用以下trick的手段来规避HTTP/1.*协议的种种限制

1. 域名分片技术
2. 当用户连接到网页时，浏览器或客户端打开到主机的多个TCP连接，为了规避最多6个TCP连接的限制，开发者将一些网页source移动到多个子域下，这样相当于增加了浏览器同时能建立的最多TCP连接数量
3. css sprites
4. css sprites技术是一种将多个图像组合成单个图像文件以便在网站上使用的方法，由于网页加载时很大一部分时间都用在了加载图片上，css sprites有助于提高网页加载性能，举例而言，我们可以将三张图像放在一个文件中，这样虽然没有减少总体要加载的文件的大小，但是会减少建立多个TCP连接需要的时间

### <b>http2</b>

2009年谷歌推出了自行研发的SPDY协议，主要用于解决HTTP/1.1的问题，此时的网络分层架构如下

![](/assets/Yqf5bgWSooC8AOxrL6jc9flhn1g.png)

SPDY协议运行在HTTP之下，TCP和SSL之上，它会将先前版本HTTP的内容封装成一种新的frame格式，这样同时就可以使用已有的SSL功能

HTTP2的特点以及仍然存在的缺陷如下：

特点

1. 头部信息压缩
2. 二进制报文格式
3. 数据包不再按顺序发送
4. 可以并发多个请求，解决了队头阻塞问题
5. 支持了服务器推送数据到客户端

缺点

1. 多个http请求复用在一个tcp连接下，当发生丢包现象时，会触发TCP的重传机制，这样这个TCP连接下的所有HTTP请求都会被阻塞

#### <b>二进制传输</b>

HTTP/2通过使用二进制传输数据以及头部信息压缩的方式，大幅减少了传输的数据量

相比于HTTP/1纯文本形式的报文，HTTP/2将请求和响应数据分割为更小的frame并使用二进制编码，示例图如下

![](/assets/PpDWbRZpOoL2QNx5cg3chYUPnoc.png)

借助于二进制传输这一特点，我们引申出如下术语

1. 流（stream），已建立的TCP连接中的双向数据流，可以携带一条或多条消息
2. 消息（message），映射到逻辑请求或响应消息的完整frame序列
3. frame，http2中的最小通信单元，每个frame都有一个frame head，标识了这个frame属于的stream

HTTP/2 将 HTTP 协议通信分解为<em>二进制编码</em>帧的交换，然后映射到属于特定流的消息，所有这些都在单个 TCP 连接中多路复用。这是启用 HTTP/2 协议提供的所有其他功能和性能优化的基础。

#### <b>头部信息压缩</b>

每个 HTTP 请求/响应都需要一组标头。在 HTTP/1.x 中，它总是以纯文本形式发送，并且需要 500-800 字节的开销和一些额外的字节用于携带cookie

HTTP/2 使用 HPACK 压缩在每次传输中压缩标头，从而减少这种开销元数据的大小并提高性能。

HPACK 压缩允许在传输时压缩单个值，并且<b>先前传输值的索引列表允许我们通过传输索引值对重复值</b>进行编码，这些索引值可用于有效地查找和重建完整的标头键和值。

由于沿编码和缓存进行压缩，标头的大小减小，从而提高了 HTTP/2 的性能

#### <b>多路复用</b>

在 HTTP/2 中引入了多路复用的技术。多路复用很好的解决了浏览器限制同一个域名下的请求数量的问题，同时也接更容易实现全速传输

![](/assets/YuR6bWxkFoYu7MxrKf4crpEpnId.png)

在上图中，单个TCP连接中包含了三个并行的stream，服务端在接收到每个stream后会将其按序号合成组合消息

借助这一技术，单个TCP连接也可以同时传送多个请求和响应，这个从根本上解决了HTTP/1时代使用域名分片，css sprites等trick手段来同时建立多个连接的痛点

#### <b>队头阻塞问题</b>

在HTTP/2中，多个请求是跑在一个TCP连接中的，当出现丢包的现象时，HTTP/2的表现就不如HTTP/1了，因为TCP为了保证可靠传输，有一个丢包重传机制，也就是丢失的包必须要等待重新传输确认，在HTTP/1中，由于开启的是多个TCP连接，出现丢包情况时只有一个TCP连接会受到影响，但在HTTP/2中，所有其余数据的传输都会受到影响

### <b>http3</b>

特点

1. 采用基于UDP协议的QUIC协议
2. 实现了快速握手
3. 优化了HTTP2的多路复用

HTTP/3相比于HTTP/2，最大的变化是让HTTP协议基于QUIC协议而不是TCP协议，QUIC协议基于UDP协议改造而成，可以很好的解决队头阻塞问题

![](/assets/LEkHbKbo6oxwqux1IlXcR7jBn9b.png)

#### <b>快速握手</b>

由于HTTP/2是基于TCP协议进行数据传输的，在建立TCP连接时，服务器和客户端需要进行三次握手才能确认连接成功，也就是需要消耗1.5个RTT才能进行数据传输，而如果还需要进行TLS连接的话，我们还需要额外花费1-2个RTT，也就是总共需要花费3-4个RTT时延

而HTTP/3是基于QUIC协议开发的，QUIC基于UDP可以实现0-1RTT就建立连接，这意味着HTTP/3可以大大提升首次打开页面的速度

#### <b>优化的多路复用</b>

与TCP不同，QUIC实现了在同一个长连接上可以有多个独立的逻辑数据流的功能，实现了数据流的单独传输，解决了TCP的队头阻塞问题

具体来说，HTTP/3中的多路复用机制可以通过以下步骤来实现：

1. 客户端向服务器发出HTTP请求，包含一个唯一的Stream ID。
2. 服务器接收到HTTP请求后，可以通过同一个连接上的不同流同时发送HTTP响应，每个响应也包含一个唯一的Stream ID。
3. 客户端接收到HTTP响应后，可以根据每个响应的Stream ID来将响应与对应的请求匹配起来。

通过这种方式，HTTP/3可以在一个连接上同时处理多个HTTP请求和响应，从而提高网络传输的效率和性能。

