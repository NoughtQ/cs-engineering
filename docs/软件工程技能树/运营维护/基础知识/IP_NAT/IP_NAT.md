---
title: IP_NAT
slug: IP_NAT
sidebar_position: 1
---


# IP_NAT

Author：卢峰杰

引言：运维基础系列第二篇，帮助你认识内网和外网的基础概念

本文阅读时间约为：15min

本文目标：科普NAT相关概念，帮助你认识用户与互联网是如何交互的

面向层级：小白，本文语言通俗易懂

![](/assets/TK2gbvpLMoODIwxtbr8ctJHenTb.png)

## 前言

对于一个尚未了解过多网络的同学来说，他一定困惑于一个问题——IP地址怎么有的是内网，有的是公网

我们该怎么对二者做区分？以及我们在访问某个网站，接受和发送数据包的时候，我们的内网和外网之间是如何切换的呢？

另外，承接[路由器](Wt7Uw3vdxi4nN1kYYIbc6BFonrh) 这篇文章，我们访问Internet资源时，其中的ip是如何自如切换的呢？

## IP地址

### 结构及类型

ipv4是我们这篇文章讨论的重点

每个IP地址内部分成两部分，即网络号和主机号。

- 网络号：也叫网络地址，用于标识大规模TCP/IP网际网络内的单个网段（即由网络组成的网络）。
- 主机号：也叫主机地址，用于识别每个网络内部的TCP/IP节点，如工作站、服务器、路由器或其它TCP/IP设备。

![](/assets/Rrm8bktoQoU9muxJoCrcU6DLnRb.png)

IP地址中的网络号和主机号总共32位，因为网络规模有所不同，为了方便网络的管理，IP地址被分为 A,B,C,D,E，5类

![](/assets/XB72bfYrioOZJ5xX8FvcCn3Yn3d.png)

1. A类地址：A类地址是用于大型网络的全球性分配，通常用于大型组织、大学、政府等。A类地址的特点是第一个字节的最高位是0，范围从1.0.0.0到126.0.0.0。A类地址的前8位是网络标识，后24位是主机标识。
2. B类地址：B类地址用于中等规模的网络，适用于中等大小的组织。B类地址的特点是第一个字节的最高位是10，范围从128.0.0.0到191.255.0.0。B类地址的前16位是网络标识，后16位是主机标识。
3. C类地址：C类地址用于小型网络，适用于小型企业、家庭等。C类地址的特点是第一个字节的最高位是110，范围从192.0.0.0到223.255.255.0。C类地址的前24位是网络标识，后8位是主机标识。
4. D类地址：D类地址用于多播通信，如前面所述，范围从224.0.0.0到239.255.255.255。它被用来支持多播组的通信，数据可以被同时传输给一组特定的接收者。
5. E类地址：E类地址是保留地址，用于实验和研究目的。范围从240.0.0.0到255.255.255.255。这些地址并未在广泛的互联网中使用。

需要注意的是，由于互联网的发展和IPv4地址空间的紧缺，传统的A、B、C类地址分类在实际应用中已经不再严格遵循，而是更加灵活地进行地址分配。IPv6的广泛采用也在一定程度上缓解了IPv4地址短缺的问题。

### 特殊IP地址

1. 广播地址

子网内的所有网络接口都能收到广播信息

直接广播：带特定网络号，主机号全为1

有线广播：网络号和主机号全为1，即255.255.255.255

1. 组播地址

- 可实现跨网段的组播(多播)地址。
- D类地址，主要用于视频广播和视频点播系统
- 地址范围从 224.0.0.0 到 239.255.255.255
- 224.0.0.1 指所有主机，224.0.0.2 指所有路由器

1. 环回地址

即127.0.0.1，localhost

1. 私有地址

也是我们通常说的内网地址

## 子网技术

### 划分方法

对于标准 A 类、B 类和 C 类地址来说，它们只具有网络号和主机号两层结构。为了划分子网，可以将其主机号分为两个部分，其中一部分用于子网号的编制，剩余部分用于主机号的编制。这样就形成了一个三层结构，即网络号、子网号、主机号。

![](/assets/GDiibiocboPcuexynkIclZ0En2f.png)

### 子网掩码

子网掩码（子网屏蔽码）与 IP 地址相同，32位二进制数。对于子网掩码的取值，对应于 IP 地址，网络号和子网号的所有二进制位设置为1，主机号的所有二进制位设置为0。所以我们不难了解到，子网掩码是一串连续的1后面一串连续的0

> 子网掩码的表示方法
> 1. 点分十进制，就像ip，例如255.255.255.0
> 2. 网络前缀表示法，通常配合ip使用，从左到右连续的取网络号和子网号的位数来表示子网掩码。比如192.168.30.1/24

> A、B、C 类网络地址的默认子网掩码：
> ![](/assets/OuRrblwhToMFgtxuH87cc0IlnGg.png)
> 要注意的是，不是说子网掩码就这么几种，这是错误的理解，这个位数是根据企业自己的情况来确定的，我们下面来看一个例子

> 某公司向相关机构申请了一个 C 类网络号：203.66.77。该公司有 4 个分布于各地的局域网络，每个网络各约有 15 台主机。
为这 4 个子网分配子网地址与子网掩码，并计算 IP 地址范围。
> 1. 确定子网位数：网络中有 4 个子网，2 ^n - 2 &gt;= 4（这是因为有两个特殊用途，看下面可以明白），求 n （子网位数）？计算得出 n = 3 位二进制位（子网位）。剩余主机位8-3=5位，则每个子网中最多容纳 2 的 5 次方 = 32 台主机。
> 2. 确定子网掩码：将 IP 地址的网络位和子网位写为 1，主机位写为 0，即可得到子网掩码。如下：
> 3. 可用子网数：3位子网位公有 000、001、010、011、100、101、110、111，8 种组合，
扣掉不可用的 000（避免代表本身：203.66.77.0）与111（避免代表广播：203.66.77.255），还有 6 个组合（子网）。如下子网地址：
> 4. 子网提供的 IP 地址范围：
> ![](/assets/PjMhbN3g5ooTnQxDHfXcIpTXnvb.webp)
> 
## 内网 NAT技术

要注意区分内网（Intranet）和子网（Subnet）

这里我们讲述一种内网管理技术，NAT（Network Address Translation，网络地址转换）

### 应用场景

当我们一个家庭，一个公司通过路由器分配到自己的内网ip地址后，想要和Internet（外网）上的主机进行通信时，就需要用到NAT技术

这种方法需要在专用网连接到因特网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和因特网连接。

### 类型

1. 静态NAT

在连接私网和公网的路由器上配置静态 NAT，每个私网地址都有一个固定的公网地址，即私网地址和公网地址是一一对应的，这种NAT不保存公网IP地址。

![](/assets/ROi9bBVl2oM9AnxKHDyc83eVnhG.png)

静态 NAT 支持双向通信

1. 动态NAT

为避免地址浪费，动态 NAT 提出了地址池，地址池中所有可用的公共地址。

![](/assets/EfFBbeGtYovUtfxSX1lcI8aLnDt.png)

配置动态NAT后，企业的边缘路由器根据可用的公网IP地址生成一个公网IP地址池。企业PC上网时，数据包经过路由器。路由器将PC的私网IP地址替换为空闲的公网IP地址，然后访问Internet。

但是PC1、PC2、PC3上网后，公司的公网IP地址池没有空闲的公网IP地址。在这种情况下，PC4 无法访问 Internet。

使用动态NAT后，公网地址和私网地址仍然是一一对应的，无法提高公网地址的利用率。

请注意，公共地址和私有地址之间的一对一映射是临时建立的。PC通过路由器翻译出来的公网IP地址是公网地址池中一个暂时空闲的公网IP地址。因此，动态NAT只支持单向访问，只能从内网访问公网。

1. NAPT

新增端口号转换功能

从地址池中选择地址时，网络地址和端口转换 (NAPT) 不仅会转换 IP 地址，还会转换端口号。这样就实现了公有地址和私有地址的一对多映射，有效地提高了公有地址的利用率。

![](/assets/Zozkb657DoJNNTxLeIncgiehnom.png)

开启NAPT后，路由器会生成动态地址和端口映射表。边缘路由器的公网IP地址池只有两个公网IP地址。PC1访问Internet上的Web服务器时，数据包携带源端口、目的端口、源地址和目的地址参数到路由器。然后，路由器进行公共地址转换和源端口转换。另外，转换后的端口号和公网IP地址都记录在动态地址和端口映射表中。最后，PC1 访问 Internet。

当WEB Server返回数据时，数据包也携带这些参数到路由器。然后，路由器查询动态地址和端口映射表，将数据包发送给PC1。

NAPT翻译传输层端口号，区分内网终端，使多个私网IP地址共享一个公网IP地址，从而节省IP地址。

> 听到这里 大家是否感觉路由器和nat之间的关系有点模糊呢？
> 其实nat是一种技术，通常家庭路由器是集成了nat功能的，所以局域网内的设备可以通过同一个公网ip访问外网，对于更大的应用场景而言，可能nat功能会单独封装为某种设备，独立于路由器存在，这就是二者的关系。

## 参考资料

https://zhuanlan.zhihu.com/p/525727765

https://zhuanlan.zhihu.com/p/26992935

